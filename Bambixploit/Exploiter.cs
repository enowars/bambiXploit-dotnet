using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using RunProcessAsTask;

namespace bambixploit
{
    public class Exploiter
    {
        private readonly Configuration settings;
        private readonly Storage storage;
        private readonly Submitter submitter;
        private long pwnRound;

        public Exploiter(Configuration settings, Submitter submitter, Storage storage)
        {
            this.settings = settings;
            this.submitter = submitter;
            this.storage = storage;
        }

        public void Start()
        {
            Task.Run(Run);
        }

        private async void Run()
        {
            while (true)
            {
                var delay = settings.Interval * 1000 / settings.Targets.Length;
                foreach (var target in settings.Targets)
                {
                    var exploitTask = Task.Run(async () => await Exploit(target, pwnRound));
                    await Task.Delay(delay);
                }

                pwnRound += 1;
                storage.LatestRound = pwnRound;
            }
        }

        private async Task Exploit(string target, long pwnRound)
        {
            using var cancelSource = new CancellationTokenSource(settings.Interval * 1000);
            var psi = new ProcessStartInfo(settings.Command, settings.Arguments + " " + target);
            var stdout = new List<string>();
            var stderr = new List<string>();
            try
            {
                var result = await ProcessEx.RunAsync(psi, stdout, stderr, cancelSource.Token);
            }
            catch (Exception e)
            {
                Console.WriteLine($"{e.Message}\n{e.StackTrace}");
            }
            finally
            {
                foreach (var line in stdout)
                {
                    var flags = settings.FlagRegex.Matches(line)
                        .Select(m => m.Value)
                        .ToArray();

                    if (flags != null)
                        foreach (var flag in flags)
                            await submitter.Enqueue(flag);
                }

                await storage.SaveLogs(stdout, stderr, pwnRound, target);
            }
        }
    }
}